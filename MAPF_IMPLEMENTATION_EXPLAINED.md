# ğŸ§  MAPFè·¯å¾„è§„åˆ’å®ç°åŸç†è¯¦è§£

## ğŸ“ æ ¸å¿ƒä»£ç æ–‡ä»¶

### 1. **`real_world/nav_world/multi_agent_planner.py`** (æ ¸å¿ƒç®—æ³•)
è¿™æ˜¯MAPFè·¯å¾„è§„åˆ’çš„æ ¸å¿ƒå®ç°æ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰å…³é”®ç®—æ³•ã€‚

### 2. **`real_world/nav_world/nav_env_mapf.py`** (é›†æˆå±‚)
å°†MAPFè§„åˆ’å™¨é›†æˆåˆ°NavEnvä¸­ï¼Œæä¾›æ˜“ç”¨çš„æ¥å£ã€‚

---

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

### 1. **ä¼˜å…ˆçº§è§„åˆ’ (Priority Planning)**

**åŸºæœ¬æ€æƒ³ï¼š**
- é«˜ä¼˜å…ˆçº§æ™ºèƒ½ä½“å…ˆè§„åˆ’è·¯å¾„
- ä½ä¼˜å…ˆçº§æ™ºèƒ½ä½“è§„åˆ’æ—¶é¿å¼€å·²è§„åˆ’çš„è·¯å¾„
- é€šè¿‡**é¢„ç•™è¡¨ (Reservation Table)** è®°å½•å·²å ç”¨çš„ä½ç½®å’Œæ—¶é—´

**ä¸ºä»€ä¹ˆæœ‰æ•ˆï¼Ÿ**
- ç®€å•é«˜æ•ˆï¼Œæ—¶é—´å¤æ‚åº¦ä½
- ä¿è¯æ— ç¢°æ’ï¼ˆå¦‚æœæ‰€æœ‰æ™ºèƒ½ä½“éƒ½èƒ½æ‰¾åˆ°è·¯å¾„ï¼‰
- é€‚åˆå®æ—¶åº”ç”¨

---

### 2. **é¢„ç•™è¡¨ (Reservation Table)** ğŸ”‘

è¿™æ˜¯MAPFçš„æ ¸å¿ƒæœºåˆ¶ï¼

#### **æ•°æ®ç»“æ„ï¼š**

```python
class ReservationTable:
    def __init__(self):
        # é¡¶ç‚¹é¢„ç•™ï¼šè®°å½•ä½ç½®-æ—¶é—´å ç”¨ (x, y, t)
        self.vertices: Set[Tuple[int, int, int]] = set()
        
        # è¾¹é¢„ç•™ï¼šè®°å½•ç§»åŠ¨è¾¹å ç”¨ (x1, y1, x2, y2, t)
        self.edges: Set[Tuple[int, int, int, int, int]] = set()
```

#### **å·¥ä½œåŸç†ï¼š**

**æ­¥éª¤1ï¼šé«˜ä¼˜å…ˆçº§æ™ºèƒ½ä½“è§„åˆ’**
```
Agent A (ä¼˜å…ˆçº§1) è§„åˆ’è·¯å¾„ï¼š
  t=0: (0,0)
  t=1: (0,1)
  t=2: (1,1)
  ...

é¢„ç•™è¡¨è®°å½•ï¼š
  vertices: {(0,0,0), (0,1,1), (1,1,2), ...}
  edges: {(0,0,0,1,0), (0,1,1,1,1), ...}
```

**æ­¥éª¤2ï¼šä½ä¼˜å…ˆçº§æ™ºèƒ½ä½“è§„åˆ’**
```
Agent B (ä¼˜å…ˆçº§2) è§„åˆ’è·¯å¾„æ—¶ï¼š
  - æ£€æŸ¥æ¯ä¸ªå€™é€‰ä½ç½® (x, y, t) æ˜¯å¦åœ¨é¢„ç•™è¡¨ä¸­
  - å¦‚æœè¢«å ç”¨ï¼Œè·³è¿‡è¯¥ä½ç½®
  - å¦‚æœç§»åŠ¨è¾¹è¢«å ç”¨ï¼Œè·³è¿‡è¯¥ç§»åŠ¨
```

---

### 3. **æ—¶é—´æ‰©å±•A* (Time-Extended A*)**

#### **ä¸æ ‡å‡†A*çš„åŒºåˆ«ï¼š**

| ç‰¹æ€§ | æ ‡å‡†A* | æ—¶é—´æ‰©å±•A* |
|------|--------|------------|
| èŠ‚ç‚¹æ ¼å¼ | `(x, y)` | `(x, y, t)` |
| æœç´¢ç©ºé—´ | 2Dç©ºé—´ | 3Dæ—¶ç©º |
| å†²çªæ£€æŸ¥ | æ—  | æ£€æŸ¥é¢„ç•™è¡¨ |
| ç­‰å¾…åŠ¨ä½œ | æ—  | æ”¯æŒåŸåœ°ç­‰å¾… |

#### **å…³é”®ä»£ç ï¼š**

```python
def astar_time_extended(grid, start, goal, reservation_table, max_time):
    # èŠ‚ç‚¹æ˜¯ (x, y, t) è€Œä¸æ˜¯ (x, y)
    g = {(start[0], start[1], 0): 0}
    
    # è·å–é‚»å±…èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬ç­‰å¾…åŠ¨ä½œï¼‰
    def get_neighbors(x, y, t):
        neighbors = []
        
        # 4æ–¹å‘ç§»åŠ¨
        for dx, dy in [(1,0), (-1,0), (0,1), (0,-1)]:
            nx, ny = x + dx, y + dy
            nt = t + 1
            
            # ğŸ”‘ å…³é”®ï¼šæ£€æŸ¥å†²çª
            if not reservation_table.has_vertex_conflict(nx, ny, nt):
                if not reservation_table.has_edge_conflict(x, y, nx, ny, t):
                    neighbors.append((nx, ny, nt))
        
        # ç­‰å¾…åŠ¨ä½œï¼šåŸåœ°åœç•™
        if not reservation_table.has_vertex_conflict(x, y, t + 1):
            neighbors.append((x, y, t + 1))
        
        return neighbors
```

---

### 4. **å†²çªç±»å‹**

#### **é¡¶ç‚¹å†²çª (Vertex Conflict)**
```
ä¸¤ä¸ªæ™ºèƒ½ä½“åœ¨åŒä¸€æ—¶é—´å æ®åŒä¸€ä½ç½®

ç¤ºä¾‹ï¼š
  Agent A: t=5 åœ¨ (3, 4)
  Agent B: t=5 åœ¨ (3, 4)  âŒ å†²çªï¼
```

**æ£€æµ‹æ–¹æ³•ï¼š**
```python
def has_vertex_conflict(self, x, y, t):
    return (x, y, t) in self.vertices  # æ£€æŸ¥é¢„ç•™è¡¨
```

#### **è¾¹å†²çª (Edge Conflict)**
```
ä¸¤ä¸ªæ™ºèƒ½ä½“åœ¨è¿ç»­æ—¶é—´æ­¥äº¤æ¢ä½ç½®

ç¤ºä¾‹ï¼š
  Agent A: t=5 åœ¨ (3,4), t=6 åœ¨ (4,4)
  Agent B: t=5 åœ¨ (4,4), t=6 åœ¨ (3,4)  âŒ å†²çªï¼
```

**æ£€æµ‹æ–¹æ³•ï¼š**
```python
def has_edge_conflict(self, x1, y1, x2, y2, t):
    # æ£€æŸ¥åå‘è¾¹æ˜¯å¦è¢«å ç”¨
    return (x2, y2, x1, y1, t) in self.edges
```

---

## ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹

### **ä¸»å‡½æ•°ï¼š`plan_priority()`**

```python
def plan_priority(grid, agents, order, max_time):
    # 1. åˆå§‹åŒ–é¢„ç•™è¡¨
    reservation_table = ReservationTable()
    paths = {}
    
    # 2. æŒ‰ä¼˜å…ˆçº§é¡ºåºè§„åˆ’
    for agent_id in order:  # ['alice', 'bob']
        agent = agent_dict[agent_id]
        
        # 3. ä¸ºå½“å‰æ™ºèƒ½ä½“è§„åˆ’è·¯å¾„ï¼ˆé¿å¼€å·²è§„åˆ’è·¯å¾„ï¼‰
        path = astar_time_extended(
            grid=grid,
            start=agent.start,
            goal=agent.goal,
            reservation_table=reservation_table,  # ğŸ”‘ ä¼ å…¥é¢„ç•™è¡¨
            max_time=max_time
        )
        
        # 4. å­˜å‚¨è·¯å¾„
        paths[agent_id] = path
        
        # 5. ğŸ”‘ å…³é”®ï¼šå°†è·¯å¾„åŠ å…¥é¢„ç•™è¡¨
        reservation_table.add_path(path)
    
    return paths
```

### **è¯¦ç»†æ­¥éª¤ç¤ºä¾‹ï¼š**

```
åœºæ™¯ï¼šä¸¤ä¸ªæ™ºèƒ½ä½“ï¼ŒAliceä¼˜å…ˆçº§é«˜äºBob

æ­¥éª¤1ï¼šè§„åˆ’Aliceçš„è·¯å¾„
  - è°ƒç”¨ astar_time_extended()
  - é¢„ç•™è¡¨ä¸ºç©ºï¼ŒAliceå¯ä»¥è‡ªç”±è§„åˆ’
  - å¾—åˆ°è·¯å¾„ï¼š[(0,0,0), (0,1,1), (1,1,2), ...]
  - å°†è·¯å¾„åŠ å…¥é¢„ç•™è¡¨

æ­¥éª¤2ï¼šè§„åˆ’Bobçš„è·¯å¾„
  - è°ƒç”¨ astar_time_extended()
  - é¢„ç•™è¡¨åŒ…å«Aliceçš„è·¯å¾„
  - æ£€æŸ¥æ¯ä¸ªå€™é€‰ä½ç½®ï¼š
    * (0,0,0) â†’ æ£€æŸ¥é¢„ç•™è¡¨ â†’ è¢«Aliceå ç”¨ â†’ è·³è¿‡
    * (0,1,1) â†’ æ£€æŸ¥é¢„ç•™è¡¨ â†’ è¢«Aliceå ç”¨ â†’ è·³è¿‡
    * (1,0,0) â†’ æ£€æŸ¥é¢„ç•™è¡¨ â†’ æœªè¢«å ç”¨ â†’ å¯ä»¥ä½¿ç”¨
  - Bobä¼šç»•å¼€Aliceçš„è·¯å¾„ï¼Œæˆ–ç­‰å¾…Aliceé€šè¿‡
  - å¾—åˆ°è·¯å¾„ï¼š[(2,0,0), (1,0,1), (0,0,2), ...]  # ç­‰å¾…Aliceé€šè¿‡(0,0)
```

---

## ğŸ’» ä»£ç ç»“æ„è¯¦è§£

### **1. ReservationTable ç±»**

```python
class ReservationTable:
    """é¢„ç•™è¡¨ï¼šè®°å½•å·²å ç”¨çš„ä½ç½®å’Œæ—¶é—´"""
    
    def add_path(self, path):
        """å°†å®Œæ•´è·¯å¾„åŠ å…¥é¢„ç•™è¡¨"""
        for i, (x, y, t) in enumerate(path):
            # é¢„ç•™é¡¶ç‚¹
            self.reserve_vertex(x, y, t)
            
            # é¢„ç•™è¾¹ï¼ˆç§»åŠ¨ï¼‰
            if i < len(path) - 1:
                x_next, y_next, t_next = path[i + 1]
                self.reserve_edge(x, y, x_next, y_next, t)
                # åŒæ—¶é¢„ç•™åå‘è¾¹ï¼ˆæ£€æµ‹äº¤æ¢å†²çªï¼‰
                self.reserve_edge(x_next, y_next, x, y, t)
```

**å…³é”®ç‚¹ï¼š**
- åŒæ—¶é¢„ç•™æ­£å‘å’Œåå‘è¾¹ï¼Œç”¨äºæ£€æµ‹äº¤æ¢å†²çª
- ä½¿ç”¨Setæ•°æ®ç»“æ„ï¼ŒæŸ¥æ‰¾æ•ˆç‡O(1)

---

### **2. astar_time_extended() å‡½æ•°**

```python
def astar_time_extended(grid, start, goal, reservation_table, max_time):
    """æ—¶é—´æ‰©å±•A*æœç´¢"""
    
    # A*æœç´¢å¾ªç¯
    while pq:
        # å¼¹å‡ºæœ€å°f-costèŠ‚ç‚¹
        f_cost, x, y, t = heapq.heappop(pq)
        
        # åˆ°è¾¾ç›®æ ‡
        if (x, y) == goal:
            return reconstruct_path()
        
        # æ‰©å±•é‚»å±…
        for nx, ny, nt in get_neighbors(x, y, t):
            # ğŸ”‘ å…³é”®ï¼šé‚»å±…èŠ‚ç‚¹å·²ç»è¿‡å†²çªæ£€æŸ¥
            # è®¡ç®—g-costå’Œf-cost
            # åŠ å…¥ä¼˜å…ˆé˜Ÿåˆ—
```

**å…³é”®ç‚¹ï¼š**
- åœ¨`get_neighbors()`ä¸­æ£€æŸ¥å†²çªï¼Œè€Œä¸æ˜¯åœ¨æ‰©å±•æ—¶æ£€æŸ¥
- æ”¯æŒç­‰å¾…åŠ¨ä½œï¼ˆåŸåœ°åœç•™ï¼‰
- ç­‰å¾…åŠ¨ä½œçš„ä»£ä»·è¾ƒä½ï¼ˆ0.5ï¼‰ï¼Œé¼“åŠ±ç§»åŠ¨

---

### **3. plan_priority() å‡½æ•°**

```python
def plan_priority(grid, agents, order, max_time):
    """ä¼˜å…ˆçº§è§„åˆ’ä¸»å‡½æ•°"""
    
    reservation_table = ReservationTable()
    paths = {}
    
    # æŒ‰ä¼˜å…ˆçº§é¡ºåºè§„åˆ’
    for agent_id in order:
        # è§„åˆ’è·¯å¾„ï¼ˆé¿å¼€å·²è§„åˆ’è·¯å¾„ï¼‰
        path = astar_time_extended(..., reservation_table, ...)
        
        # å­˜å‚¨è·¯å¾„
        paths[agent_id] = path
        
        # ğŸ”‘ å…³é”®ï¼šæ›´æ–°é¢„ç•™è¡¨
        reservation_table.add_path(path)
    
    return paths
```

**å…³é”®ç‚¹ï¼š**
- é¡ºåºè§„åˆ’ï¼šé«˜ä¼˜å…ˆçº§å…ˆè§„åˆ’
- é¢„ç•™è¡¨ç´¯ç§¯ï¼šæ¯ä¸ªæ™ºèƒ½ä½“çš„è·¯å¾„éƒ½ä¼šåŠ å…¥é¢„ç•™è¡¨
- ä¿è¯æ— ç¢°æ’ï¼šåç»­æ™ºèƒ½ä½“å¿…é¡»é¿å¼€å·²è§„åˆ’è·¯å¾„

---

## ğŸ”— ä¸NavEnvçš„é›†æˆ

### **NavEnvMAPF ç±»**

```python
class NavEnvMAPF(NavEnv):
    """å¢å¼ºç‰ˆNavEnvï¼Œä½¿ç”¨MAPFè§„åˆ’"""
    
    def _plan_paths_mapf(self):
        """ä½¿ç”¨MAPFè§„åˆ’è·¯å¾„"""
        # 1. åˆ›å»ºAgentSpecå¯¹è±¡
        agents = [
            AgentSpec(id='alice', start=(15,10), goal=(70,46)),
            AgentSpec(id='bob', start=(15,50), goal=(72,20))
        ]
        
        # 2. è°ƒç”¨MAPFè§„åˆ’å™¨
        self.mapf_paths = plan_priority(
            grid=self.grid,
            agents=agents,
            order=self.priority_order,  # ['alice', 'bob']
            max_time=200
        )
        
        # 3. è½¬æ¢æ—¶é—´æˆ³è·¯å¾„ä¸ºä¸–ç•Œåæ ‡è·¯å¾„
        for agt in self.agent_names:
            path_grid_time = self.mapf_paths[agt]
            # æå–ç©ºé—´è·¯å¾„ï¼ˆå¿½ç•¥æ—¶é—´ï¼‰
            path_grid = extract_spatial_path(path_grid_time)
            # è½¬æ¢ä¸ºä¸–ç•Œåæ ‡
            path_world = [self._grid2world(ix, iy) for (ix, iy) in path_grid]
            self.agents[agt].path_world = path_world
```

**å…³é”®ç‚¹ï¼š**
- ç»§æ‰¿NavEnvï¼Œä¿æŒå…¼å®¹æ€§
- å°†æ—¶é—´æˆ³è·¯å¾„è½¬æ¢ä¸ºç©ºé—´è·¯å¾„
- æ”¯æŒä¼˜å…ˆçº§é¡ºåºè®¾ç½®

---

## ğŸ“Š ç®—æ³•å¤æ‚åº¦

### **æ—¶é—´å¤æ‚åº¦ï¼š**
- **å•æ™ºèƒ½ä½“è§„åˆ’ï¼š** O(n Ã— m Ã— T)
  - n = ç½‘æ ¼è¡Œæ•°
  - m = ç½‘æ ¼åˆ—æ•°
  - T = æœ€å¤§æ—¶é—´æ­¥æ•°
- **å¤šæ™ºèƒ½ä½“è§„åˆ’ï¼š** O(k Ã— n Ã— m Ã— T)
  - k = æ™ºèƒ½ä½“æ•°é‡

### **ç©ºé—´å¤æ‚åº¦ï¼š**
- **é¢„ç•™è¡¨ï¼š** O(k Ã— T)
- **A*æœç´¢ï¼š** O(n Ã— m Ã— T)

---

## ğŸ¯ ä¼˜åŠ¿ä¸å±€é™

### **ä¼˜åŠ¿ï¼š**
âœ… **ç®€å•é«˜æ•ˆ**ï¼šå®ç°ç®€å•ï¼Œè¿è¡Œå¿«é€Ÿ  
âœ… **ä¿è¯æ— ç¢°æ’**ï¼šå¦‚æœæ‰€æœ‰æ™ºèƒ½ä½“éƒ½èƒ½æ‰¾åˆ°è·¯å¾„ï¼Œä¿è¯æ— ç¢°æ’  
âœ… **æ”¯æŒç­‰å¾…**ï¼šæ™ºèƒ½ä½“å¯ä»¥ç­‰å¾…ä»¥é¿å…å†²çª  
âœ… **å®æ—¶æ€§**ï¼šé€‚åˆå®æ—¶åº”ç”¨  

### **å±€é™ï¼š**
âŒ **éæœ€ä¼˜**ï¼šä¼˜å…ˆçº§é¡ºåºå½±å“è§£çš„è´¨é‡  
âŒ **å¯èƒ½å¤±è´¥**ï¼šå¦‚æœä½ä¼˜å…ˆçº§æ™ºèƒ½ä½“æ— æ³•é¿å¼€é«˜ä¼˜å…ˆçº§è·¯å¾„ï¼Œè§„åˆ’å¤±è´¥  
âŒ **é¡ºåºæ•æ„Ÿ**ï¼šä¸åŒçš„ä¼˜å…ˆçº§é¡ºåºå¯èƒ½å¾—åˆ°ä¸åŒçš„ç»“æœ  

---

## ğŸ” è°ƒè¯•æŠ€å·§

### **æŸ¥çœ‹é¢„ç•™è¡¨å†…å®¹ï¼š**

```python
# åœ¨plan_priority()ä¸­æ·»åŠ è°ƒè¯•è¾“å‡º
print(f"Reservation table after {agent_id}:")
print(f"  Vertices: {len(reservation_table.vertices)}")
print(f"  Edges: {len(reservation_table.edges)}")
```

### **å¯è§†åŒ–è·¯å¾„ï¼š**

```python
# ä½¿ç”¨test_mapf.pyå¯è§†åŒ–
python real_world/nav_world/test_mapf.py
```

---

## ğŸ“š ç›¸å…³è®ºæ–‡

- **Priority Planning**: ç»å…¸çš„MAPFå¯å‘å¼ç®—æ³•
- **Reservation Table**: ç©ºé—´-æ—¶é—´å†²çªé¿å…æœºåˆ¶
- **Time-Extended A***: å°†A*æ‰©å±•åˆ°æ—¶é—´ç»´åº¦

---

## ğŸš€ æ‰©å±•æ–¹å‘

1. **åŠ¨æ€ä¼˜å…ˆçº§è°ƒæ•´**ï¼šæ ¹æ®æƒ…å†µåŠ¨æ€æ”¹å˜ä¼˜å…ˆçº§
2. **å†²çªè§£å†³ç­–ç•¥**ï¼šå½“è§„åˆ’å¤±è´¥æ—¶çš„å›é€€æœºåˆ¶
3. **æœ€ä¼˜æ€§ä¿è¯**ï¼šä½¿ç”¨CBS (Conflict-Based Search) ç­‰ç®—æ³•
4. **å¤§è§„æ¨¡ä¼˜åŒ–**ï¼šé’ˆå¯¹å¤§é‡æ™ºèƒ½ä½“çš„ä¼˜åŒ–

---

## ğŸ’¡ æ€»ç»“

MAPFè·¯å¾„è§„åˆ’çš„æ ¸å¿ƒæ˜¯ï¼š
1. **é¢„ç•™è¡¨æœºåˆ¶**ï¼šè®°å½•å·²å ç”¨çš„ä½ç½®å’Œæ—¶é—´
2. **æ—¶é—´æ‰©å±•A***ï¼šåœ¨æ—¶ç©ºç©ºé—´ä¸­æœç´¢
3. **ä¼˜å…ˆçº§è§„åˆ’**ï¼šæŒ‰é¡ºåºè§„åˆ’ï¼Œåç»­æ™ºèƒ½ä½“é¿å¼€å·²è§„åˆ’è·¯å¾„

è¿™ç§æ–¹æ³•çš„ä¼˜åŠ¿æ˜¯ç®€å•é«˜æ•ˆï¼Œé€‚åˆå®æ—¶åº”ç”¨ï¼Œè™½ç„¶ä¸èƒ½ä¿è¯æœ€ä¼˜è§£ï¼Œä½†èƒ½ä¿è¯æ— ç¢°æ’ã€‚

